name: Scrape

on:
  schedule:
    - cron: "0 */3 * * *"   # every 3 hours UTC
  workflow_dispatch:         # allow manual trigger

concurrency:
  group: scrape
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip xvfb
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Pick city for this run (Egypt → Arab capitals → Global)
        id: pick
        shell: bash
        run: |
          # Use a HEREDOC so we can keep a long list tidy.
          # One city per line, exactly as you want it sent to the scraper.
          mapfile -t cities <<'EOF'
          # --- Egypt (governorate capitals / major cities) ---
          Port Said, Egypt
          Suez, Egypt
          Ismailia, Egypt
          Tanta, Egypt
          Mansoura, Egypt
          Zagazig, Egypt
          Damietta, Egypt
          Kafr El Sheikh, Egypt
          Damanhur, Egypt
          Shebin El Kom, Egypt
          Banha, Egypt
          Fayoum, Egypt
          Beni Suef, Egypt
          Minya, Egypt
          Asyut, Egypt
          Sohag, Egypt
          Qena, Egypt
          Luxor, Egypt
          Aswan, Egypt
          Hurghada, Egypt
          Sharm El Sheikh, Egypt
          Arish, Egypt
          # --- Arab capitals (de facto/admin where relevant) ---
          Algiers, Algeria
          Manama, Bahrain
          Cairo, Egypt
          Baghdad, Iraq
          Amman, Jordan
          Kuwait City, Kuwait
          Beirut, Lebanon
          Tripoli, Libya
          Nouakchott, Mauritania
          Rabat, Morocco
          Muscat, Oman
          Doha, Qatar
          Riyadh, Saudi Arabia
          Khartoum, Sudan
          Damascus, Syria
          Tunis, Tunisia
          Abu Dhabi, United Arab Emirates
          Sana'a, Yemen
          Djibouti, Djibouti
          Mogadishu, Somalia
          Moroni, Comoros
          Ramallah, Palestine
          # --- International priority cities ---
          Paris, France
          London, United Kingdom
          New York, USA
          Los Angeles, USA
          San Francisco, USA
          Chicago, USA
          Toronto, Canada
          Vancouver, Canada
          Berlin, Germany
          Munich, Germany
          Madrid, Spain
          Barcelona, Spain
          Rome, Italy
          Milan, Italy
          Istanbul, Türkiye
          Athens, Greece
          Amsterdam, Netherlands
          Brussels, Belgium
          Zurich, Switzerland
          Vienna, Austria
          Copenhagen, Denmark
          Stockholm, Sweden
          Oslo, Norway
          Helsinki, Finland
          Warsaw, Poland
          Prague, Czechia
          Budapest, Hungary
          Lisbon, Portugal
          Dublin, Ireland
          Dubai, United Arab Emirates
          Singapore, Singapore
          Hong Kong
          Tokyo, Japan
          Osaka, Japan
          Seoul, South Korea
          Sydney, Australia
          Melbourne, Australia
          Auckland, New Zealand
          Mexico City, Mexico
          São Paulo, Brazil
          Buenos Aires, Argentina
          Johannesburg, South Africa
          Casablanca, Morocco
          EOF

          # Strip comments/blank lines
          filtered=()
          for c in "${cities[@]}"; do
            [[ -z "$c" ]] && continue
            [[ "$c" =~ ^# ]] && continue
            filtered+=("$c")
          done

          count=${#filtered[@]}
          if [[ $count -eq 0 ]]; then
            echo "No cities configured"; exit 1
          fi

          # Rotate by repository-wide run number
          idx=$(( GITHUB_RUN_NUMBER % count ))
          city="${filtered[$idx]}"

          # Expose CITY and a filesystem-safe variant
          echo "CITY=$city" >> "$GITHUB_ENV"
          safe="$(echo "$city" | tr '[:space:]/,' '_')"
          echo "CITY_SAFE=$safe" >> "$GITHUB_ENV"

          echo "Picked city: $city"

      - name: Run scraper (never fail even if scraper crashes at the end)
        run: |
          echo "Scraping city: $CITY"
          python maps.py --categories-file categories.txt --location "$CITY" --max-places 1 --output TheResultss.csv --headless || true

      - name: Clean CSV
        run: |
          python csv_cleaner.py --in TheResultss.csv --out Cleaned.csv

      - name: Push to Supabase
        run: python supabase_push.py Cleaned.csv
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}

      - name: Upload cleaned CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: cleaned_csv_${{ env.CITY_SAFE }}
          path: Cleaned.csv
