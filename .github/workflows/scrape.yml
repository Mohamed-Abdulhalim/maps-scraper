name: Scrape

on:
  schedule:
    - cron: "0 */10 * * *"
  workflow_dispatch:
    inputs:
      reset:
        description: "Reset city rotation to the top"
        type: boolean
        required: false
        default: false

concurrency:
  group: scrape
  cancel-in-progress: false

permissions:
  contents: write   # needed to commit the rotation_index.txt

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # we’re going to commit a tiny state file

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip xvfb
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Pick city for this run (using persistent rotation)
        id: pick
        shell: bash
        env:
          RESET: ${{ github.event.inputs.reset }}
        run: |
          state_file=".github/rotation_index.txt"

          mapfile -t cities <<'EOF'
          # --- Egypt (governorate capitals / major cities) ---
          Cairo, Egypt
          Alexandria, Egypt
          Giza, Egypt
          Port Said, Egypt
          Suez, Egypt
          Ismailia, Egypt
          Tanta, Egypt
          Mansoura, Egypt
          Zagazig, Egypt
          Damietta, Egypt
          Kafr El Sheikh, Egypt
          Damanhur, Egypt
          Shebin El Kom, Egypt
          Banha, Egypt
          Fayoum, Egypt
          Beni Suef, Egypt
          Minya, Egypt
          Asyut, Egypt
          Sohag, Egypt
          Qena, Egypt
          Luxor, Egypt
          Aswan, Egypt
          Hurghada, Egypt
          Sharm El Sheikh, Egypt
          Arish, Egypt
          # --- Arab capitals (de facto/admin where relevant) ---
          # --- Algiers, Algeria
          # --- Manama, Bahrain
          # --- Cairo, Egypt
          # --- Baghdad, Iraq
          # --- Amman, Jordan
          # --- Kuwait City, Kuwait
          # --- Beirut, Lebanon
          # --- Tripoli, Libya
          # --- Nouakchott, Mauritania
          # --- Rabat, Morocco
          # --- Muscat, Oman
          # --- Doha, Qatar
          # --- Riyadh, Saudi Arabia
          # --- Khartoum, Sudan
          # --- Damascus, Syria
          # --- Tunis, Tunisia
          # --- Abu Dhabi, United Arab Emirates
          # --- Sana'a, Yemen
          # --- Djibouti, Djibouti
          # --- Mogadishu, Somalia
          # --- Moroni, Comoros
          # --- Ramallah, Palestine
          # --- International priority cities ---
          # --- Paris, France
          # --- London, United Kingdom
          # --- New York, USA
          # --- Los Angeles, USA
          # --- San Francisco, USA
          # --- Chicago, USA
          # --- Toronto, Canada
          # --- Vancouver, Canada
          # --- Berlin, Germany
          # --- Munich, Germany
          # --- Madrid, Spain
          # --- Barcelona, Spain
          # --- Rome, Italy
          # --- Milan, Italy
          # --- Istanbul, Türkiye
          # --- Athens, Greece
          # --- Amsterdam, Netherlands
          # --- Brussels, Belgium
          # --- Zurich, Switzerland
          # --- Vienna, Austria
          # --- Copenhagen, Denmark
          # --- Stockholm, Sweden
          # --- Oslo, Norway
          # --- Helsinki, Finland
          # --- Warsaw, Poland
          # --- Prague, Czechia
          # --- Budapest, Hungary
          # --- Lisbon, Portugal
          # --- Dublin, Ireland
          # --- Dubai, United Arab Emirates
          # --- Singapore, Singapore
          # --- Hong Kong
          # --- Tokyo, Japan
          # --- Osaka, Japan
          # --- Seoul, South Korea
          # --- Sydney, Australia
          # --- Melbourne, Australia
          # --- Auckland, New Zealand
          # --- Mexico City, Mexico
          # --- São Paulo, Brazil
          # --- Buenos Aires, Argentina
          # --- Johannesburg, South Africa
          # --- Casablanca, Morocco
          EOF

          # Strip comments/blanks
          filtered=()
          for c in "${cities[@]}"; do
            [[ -z "$c" ]] && continue
            [[ "$c" =~ ^# ]] && continue
            filtered+=("$c")
          done

          count=${#filtered[@]}
          if [[ $count -eq 0 ]]; then
            echo "No cities configured"; exit 1
          fi

          # Determine current index
          if [[ "$RESET" == "true" ]]; then
            idx=0
          elif [[ -f "$state_file" ]]; then
            read -r idx < "$state_file" || idx=0
          else
            idx=0
          fi

          # Bounds check
          if (( idx < 0 || idx >= count )); then
            idx=0
          fi

          city="${filtered[$idx]}"
          echo "CITY=$city" >> "$GITHUB_ENV"
          safe="$(echo "$city" | tr '[:space:]/,' '_')"
          echo "CITY_SAFE=$safe" >> "$GITHUB_ENV"

          # Compute next index and persist to file
          next_idx=$(( (idx + 1) % count ))
          mkdir -p "$(dirname "$state_file")"
          echo "$next_idx" > "$state_file"

          echo "Picked city: $city (index $idx of $count). Next index will be $next_idx."

      - name: Persist rotation index
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/rotation_index.txt
          git commit -m "chore: advance rotation index to ${{ env.CITY_SAFE }}" || echo "No changes to commit"
          git push

      - name: Run scraper (never fail even if scraper crashes at the end)
        run: |
          echo "Scraping city: $CITY"
          python maps.py --categories-file categories.txt --location "$CITY" --max-places 50 --output TheResultss.csv --headless || true

      - name: Clean CSV
        run: |
          python csv_cleaner.py --in TheResultss.csv --out Cleaned.csv

      - name: Enrich phones from detail pages
        run: |
          python phone_enricher.py --in Cleaned.csv --out Enriched.csv --limit 100000

      - name: Push to Supabase
        run: python supabase_push.py Enriched.csv
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}

      - name: Upload enriched CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: enriched_csv_${{ env.CITY_SAFE }}
          path: Enriched.csv

